#
# ghci-koji - Contained Koji Instance
#
# This images provides a Koji instance (Fedora Package Building Infrastructure)
# together with a PostgreSQL database. It is meant as self-contained solution
# for testing infrastructure to run against local Koji.
#
# The following values are currently hard-coded into the image:
# - admin account:          kojiadmin/kojipass
# - non-privileged account:  osbuild/osbuildpass
# - content generator:      osbuild (osbuild user has access to it)

FROM docker.io/library/fedora:latest

# koji db schema is in docs, remove nodocs from from dnf config
RUN sed  -i '/^tsflags=nodocs$/d' /etc/dnf/dnf.conf

RUN dnf -y upgrade \
    && dnf -y \
            --setopt=fastestmirror=True \
            --setopt=install_weak_deps=False \
            install \
                    koji-hub \
                    postgresql \
    && dnf clean all

RUN mkdir -p /mnt/koji/{packages,repos,work,scratch,repos-dist}

RUN chown -R apache:apache /mnt/koji

COPY ci/run-koji.sh /ci/

ENTRYPOINT /ci/run-koji.sh
